// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// Prisma schema file

// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  telegramId             Int     @id
  username               String?
  goldBalance            Int     @default(0)
  level                  Int     @default(1)
  expToNextLevel         Int     @default(42) @map("exp_to_next_level")
  exp                    Int     @default(0)
  str                    Int     @default(1)
  def                    Int     @default(1)
  dex                    Int     @default(1)
  magic                  Int     @default(1)
  hpLevel                Int     @default(1) @map("hp_level")
  expHp                  Int     @default(0) @map("exp_hp")
  expToNextHpLevel       Int     @default(42) @map("exp_to_next_hp_level")
  outstandingSkillPoints Int     @default(0) @map("outstanding_skill_points")

  // Optional equipment relationships
  hatId       Int? @unique
  armourId    Int? @unique
  weaponId    Int? @unique
  shieldId    Int? @unique
  capeId      Int? @unique
  necklaceId  Int? @unique
  petId       Int? @unique
  spellbookId Int? @unique

  // Relations to the EquipmentInventory table
  hat       EquipmentInventory? @relation("Hat", fields: [hatId], references: [id])
  armour    EquipmentInventory? @relation("Armour", fields: [armourId], references: [id])
  weapon    EquipmentInventory? @relation("Weapon", fields: [weaponId], references: [id])
  shield    EquipmentInventory? @relation("Shield", fields: [shieldId], references: [id])
  cape      EquipmentInventory? @relation("Cape", fields: [capeId], references: [id])
  necklace  EquipmentInventory? @relation("Necklace", fields: [necklaceId], references: [id])
  pet       EquipmentInventory? @relation("Pet", fields: [petId], references: [id])
  spellbook EquipmentInventory? @relation("Spellbook", fields: [spellbookId], references: [id])

  // User relations to inventories
  equipmentInventory EquipmentInventory[]
  itemInventory      ItemInventory[]

  // Relation to Combat stats
  combat Combat?

  // Relation to slimes
  Slime Slime[]

  // Relation to equipped slime
  equippedSlimeId Int?   @unique
  equippedSlime   Slime? @relation("EquippedSlime", fields: [equippedSlimeId], references: [id])
}

model Combat {
  userId  Int @id
  str     Int @default(1)
  def     Int @default(1)
  dex     Int @default(1)
  magic   Int @default(1)
  hp      Int @default(10)
  hpLevel Int @default(1)

  // Relation back to the User
  user User @relation(fields: [userId], references: [telegramId])
}

// Define enums for Rarity and Type
enum Rarity {
  S
  A
  B
  C
  D
}

enum TraitType {
  Aura
  Body
  Core
  Headpiece
  Tail
  Arms
  Eyes
  Mouth
}

model Slime {
  id         Int   @id @default(autoincrement())
  ownerId    Int
  owner      User  @relation(fields: [ownerId], references: [telegramId])
  equippedBy User? @relation("EquippedSlime")

  // Traits with dominant and hidden genes
  Aura_D  Int
  Aura_H1 Int
  Aura_H2 Int
  Aura_H3 Int

  Body_D  Int
  Body_H1 Int
  Body_H2 Int
  Body_H3 Int

  Core_D  Int
  Core_H1 Int
  Core_H2 Int
  Core_H3 Int

  Headpiece_D  Int
  Headpiece_H1 Int
  Headpiece_H2 Int
  Headpiece_H3 Int

  Tail_D  Int
  Tail_H1 Int
  Tail_H2 Int
  Tail_H3 Int

  Arms_D  Int
  Arms_H1 Int
  Arms_H2 Int
  Arms_H3 Int

  Eyes_D  Int
  Eyes_H1 Int
  Eyes_H2 Int
  Eyes_H3 Int

  Mouth_D  Int
  Mouth_H1 Int
  Mouth_H2 Int
  Mouth_H3 Int

  // Relations to SlimeTrait
  AuraDominant SlimeTrait @relation("AuraDominant", fields: [Aura_D], references: [id])
  AuraHidden1  SlimeTrait @relation("AuraHidden1", fields: [Aura_H1], references: [id])
  AuraHidden2  SlimeTrait @relation("AuraHidden2", fields: [Aura_H2], references: [id])
  AuraHidden3  SlimeTrait @relation("AuraHidden3", fields: [Aura_H3], references: [id])

  BodyDominant SlimeTrait @relation("BodyDominant", fields: [Body_D], references: [id])
  BodyHidden1  SlimeTrait @relation("BodyHidden1", fields: [Body_H1], references: [id])
  BodyHidden2  SlimeTrait @relation("BodyHidden2", fields: [Body_H2], references: [id])
  BodyHidden3  SlimeTrait @relation("BodyHidden3", fields: [Body_H3], references: [id])

  CoreDominant SlimeTrait @relation("CoreDominant", fields: [Core_D], references: [id])
  CoreHidden1  SlimeTrait @relation("CoreHidden1", fields: [Core_H1], references: [id])
  CoreHidden2  SlimeTrait @relation("CoreHidden2", fields: [Core_H2], references: [id])
  CoreHidden3  SlimeTrait @relation("CoreHidden3", fields: [Core_H3], references: [id])

  HeadpieceDominant SlimeTrait @relation("HeadpieceDominant", fields: [Headpiece_D], references: [id])
  HeadpieceHidden1  SlimeTrait @relation("HeadpieceHidden1", fields: [Headpiece_H1], references: [id])
  HeadpieceHidden2  SlimeTrait @relation("HeadpieceHidden2", fields: [Headpiece_H2], references: [id])
  HeadpieceHidden3  SlimeTrait @relation("HeadpieceHidden3", fields: [Headpiece_H3], references: [id])

  TailDominant SlimeTrait @relation("TailDominant", fields: [Tail_D], references: [id])
  TailHidden1  SlimeTrait @relation("TailHidden1", fields: [Tail_H1], references: [id])
  TailHidden2  SlimeTrait @relation("TailHidden2", fields: [Tail_H2], references: [id])
  TailHidden3  SlimeTrait @relation("TailHidden3", fields: [Tail_H3], references: [id])

  ArmsDominant SlimeTrait @relation("ArmsDominant", fields: [Arms_D], references: [id])
  ArmsHidden1  SlimeTrait @relation("ArmsHidden1", fields: [Arms_H1], references: [id])
  ArmsHidden2  SlimeTrait @relation("ArmsHidden2", fields: [Arms_H2], references: [id])
  ArmsHidden3  SlimeTrait @relation("ArmsHidden3", fields: [Arms_H3], references: [id])

  EyesDominant SlimeTrait @relation("EyesDominant", fields: [Eyes_D], references: [id])
  EyesHidden1  SlimeTrait @relation("EyesHidden1", fields: [Eyes_H1], references: [id])
  EyesHidden2  SlimeTrait @relation("EyesHidden2", fields: [Eyes_H2], references: [id])
  EyesHidden3  SlimeTrait @relation("EyesHidden3", fields: [Eyes_H3], references: [id])

  MouthDominant SlimeTrait @relation("MouthDominant", fields: [Mouth_D], references: [id])
  MouthHidden1  SlimeTrait @relation("MouthHidden1", fields: [Mouth_H1], references: [id])
  MouthHidden2  SlimeTrait @relation("MouthHidden2", fields: [Mouth_H2], references: [id])
  MouthHidden3  SlimeTrait @relation("MouthHidden3", fields: [Mouth_H3], references: [id])
}

model SlimeTrait {
  id         Int       @id @default(autoincrement())
  type       TraitType
  name       String
  rarity     Rarity
  pairId     Int? // Points to another SlimeTrait as a potential pair
  mutationId Int? // Points to another SlimeTrait representing mutation to the next gen

  str   Int @default(0)
  def   Int @default(0)
  dex   Int @default(0)
  magic Int @default(0)
  hp    Int @default(0)

  pair     SlimeTrait? @relation("Pair", fields: [pairId], references: [id])
  mutation SlimeTrait? @relation("Mutation", fields: [mutationId], references: [id])

  // Reverse relations for pair and mutation
  pairedTraits   SlimeTrait[] @relation("Pair")
  mutationTraits SlimeTrait[] @relation("Mutation")

  // Relations to Slime (reverse)
  slimesAsAuraDominant Slime[] @relation("AuraDominant")
  slimesAsAuraHidden1  Slime[] @relation("AuraHidden1")
  slimesAsAuraHidden2  Slime[] @relation("AuraHidden2")
  slimesAsAuraHidden3  Slime[] @relation("AuraHidden3")

  slimesAsBodyDominant Slime[] @relation("BodyDominant")
  slimesAsBodyHidden1  Slime[] @relation("BodyHidden1")
  slimesAsBodyHidden2  Slime[] @relation("BodyHidden2")
  slimesAsBodyHidden3  Slime[] @relation("BodyHidden3")

  slimesAsCoreDominant Slime[] @relation("CoreDominant")
  slimesAsCoreHidden1  Slime[] @relation("CoreHidden1")
  slimesAsCoreHidden2  Slime[] @relation("CoreHidden2")
  slimesAsCoreHidden3  Slime[] @relation("CoreHidden3")

  slimesAsHeadpieceDominant Slime[] @relation("HeadpieceDominant")
  slimesAsHeadpieceHidden1  Slime[] @relation("HeadpieceHidden1")
  slimesAsHeadpieceHidden2  Slime[] @relation("HeadpieceHidden2")
  slimesAsHeadpieceHidden3  Slime[] @relation("HeadpieceHidden3")

  slimesAsTailDominant Slime[] @relation("TailDominant")
  slimesAsTailHidden1  Slime[] @relation("TailHidden1")
  slimesAsTailHidden2  Slime[] @relation("TailHidden2")
  slimesAsTailHidden3  Slime[] @relation("TailHidden3")

  slimesAsArmsDominant Slime[] @relation("ArmsDominant")
  slimesAsArmsHidden1  Slime[] @relation("ArmsHidden1")
  slimesAsArmsHidden2  Slime[] @relation("ArmsHidden2")
  slimesAsArmsHidden3  Slime[] @relation("ArmsHidden3")

  slimesAsEyesDominant Slime[] @relation("EyesDominant")
  slimesAsEyesHidden1  Slime[] @relation("EyesHidden1")
  slimesAsEyesHidden2  Slime[] @relation("EyesHidden2")
  slimesAsEyesHidden3  Slime[] @relation("EyesHidden3")

  slimesAsMouthDominant Slime[] @relation("MouthDominant")
  slimesAsMouthHidden1  Slime[] @relation("MouthHidden1")
  slimesAsMouthHidden2  Slime[] @relation("MouthHidden2")
  slimesAsMouthHidden3  Slime[] @relation("MouthHidden3")
}

enum EquipmentType {
  hat
  armour
  weapon
  shield
  cape
  necklace
  pet
  spellbook
}

// Equipment table
model Equipment {
  id          Int           @id @default(autoincrement())
  name        String        @unique
  description String        @default("")
  str         Int           @default(0)
  def         Int           @default(0)
  dex         Int           @default(0)
  magic       Int           @default(0)
  hp          Int           @default(0)
  rarity      Rarity
  type        EquipmentType // hat, armour, weapon, shield, cape, necklace, pet, spellbook

  equipmentInventory EquipmentInventory[]

  CraftingRecipe CraftingRecipe[]
}

// Items table
model Item {
  itemId       Int         @id @default(autoincrement())
  name         String      @unique
  description  String      @default("")
  rarity       Rarity
  consumableId Int?
  consumable   Consumable? @relation(fields: [consumableId], references: [id])

  itemInventory ItemInventory[]

  CraftingRecipeItems CraftingRecipeItems[]
}

// Equipment Inventory table
model EquipmentInventory {
  id          Int @id @default(autoincrement())
  equipmentId Int
  userId      Int

  equipment Equipment @relation(fields: [equipmentId], references: [id])
  user      User      @relation(fields: [userId], references: [telegramId])

  // Opposite relations for the equipment types (mirroring the User relations)
  hat       User? @relation("Hat")
  armour    User? @relation("Armour")
  weapon    User? @relation("Weapon")
  shield    User? @relation("Shield")
  cape      User? @relation("Cape")
  necklace  User? @relation("Necklace")
  pet       User? @relation("Pet")
  spellbook User? @relation("Spellbook")
}

// Item Inventory table
model ItemInventory {
  id       Int @id @default(autoincrement())
  itemId   Int
  userId   Int
  quantity Int

  item Item @relation(fields: [itemId], references: [itemId])
  user User @relation(fields: [userId], references: [telegramId])

  // Enforce unique combination of userId and itemId
  @@unique([userId, itemId])
}

// Define an enum for effect types
enum EffectType {
  plus // Represented as "+"
  times // Represented as "*"
}

// Consumable table using enums for effects
model Consumable {
  id Int @id @default(autoincrement())

  str       Int?
  strEffect EffectType? @map("str_effect")

  def       Int?
  defEffect EffectType? @map("def_effect")

  dex       Int?
  dexEffect EffectType? @map("dex_effect")

  magic       Int?
  magicEffect EffectType? @map("magic_effect")

  hp       Int?
  hpEffect EffectType? @map("hp_effect")

  maxHp       Int?        @map("max_hp")
  maxHpEffect EffectType? @map("max_hp_effect")

  durationS Int? // Duration in seconds for consumables

  Item Item[]
}

model CraftingRecipe {
  id          Int       @id @default(autoincrement())
  equipmentId Int       @unique
  equipment   Equipment @relation(fields: [equipmentId], references: [id])
  durationS   Int

  // This table defines the items required for crafting
  CraftingRecipeItems CraftingRecipeItems[]
}

model CraftingRecipeItems {
  id       Int            @id @default(autoincrement())
  recipeId Int
  recipe   CraftingRecipe @relation(fields: [recipeId], references: [id])
  itemId   Int
  item     Item           @relation(fields: [itemId], references: [itemId])
  quantity Int            @default(1) // Number of items required to craft the equipment

  @@unique([recipeId, itemId]) // Ensure unique combination of item and recipe
}
